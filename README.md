2025/12/06更新、土田
# 西田さん論文再現コード

## 環境構築
- githubをクローンする
    - コマンド：git clone "wikiに書いてあるURL".git "自分のディレクトリへのパス"
        - 例：git clone https://github.com/LLrikuto/tsuchida_article_gen_hikitsugi/.git /home/rikutotsuchida0329/work/
    - アクセストークンみたいなものが必要になる可能性がある
- コンテナを作り、pythonコマンドが使えるようにする
    - python3 --version で使えるか確認できる
    - コンテナの作り方は学習済みのはずなのでチュートリアルを参照・・・http://nlp.iit.tsukuba.ac.jp/local/wiki/index.php?%C0%BE%C5%C4%A1%A7Docker%B4%D8%B7%B8

## 1．データ収集（スクレイピング）
- 事前にwikiに書いてあるcsvファイルを作成しておく
    - ファイル名は「株価変動ランキングの日付_data.csv」,（例：20251205_data.csv）
- src/1_scr_kabutan.pyを使用
    - 11行目で必ず日付を指定する
        - 今日の日付ではなく、株探の株価変動ランキングの日付
    - python src/1_scr_kabutan.pyで実行
- コードの概要
    - 事前に作ったcsvファイルから企業発情報のURLとタイトルを取得する
    - 最新の記事と指定した日から１か月以内の記事を取得する
- 出力ファイル
    - out/"11行目の日付"/scr_result/"11行目の日付".csv
    - 出力ファイルは2種類あり、メインは上記のファイル
    - 「out/"11行目の日付"/scr_result/"11行目の日付"_extra.csv」がもう一つのファイル
        - 最新ではないが１か月以内の企業発情報のURLを保存している

## 2. PDFをデータ化
- 実行する前にまたcsvファイルで作業を行う（詳細はwikiに）
    - csvファイルをdata/に、PDFはPDF_data/"ランキングの日付"/に置く
- 2_make_vector_store.pyを使用
    - 12行目で必ず日付を指定する
        - 今日の日付ではなく、株探の株価変動ランキングの日付
    - python src/2_make_vector_store.pyで実行
- 入力ファイル
    - data/"ランキングの日付".csv
        - 先ほど置いたcsvファイルを指定している（19行目）
    - data/PDF_data/日付/
        - 今回の日付のPDFを全てここに置いてある（95行目）
- 出力ファイル
    - out/"日付"/make_store/のテキストファイル
        - ファイル内の下部に書いてある「全ファイル確認」以降の内容をチェックし、ステータスがcompleteであることを確認する
    - テキストファイル上部のストアIDは今後使うので注意
- コード概要
    - 初めにストアIDを作成し、そこにPDFを登録するコード
    - 登録後はこちらから全く見えないので必ずメタデータを記録する
        - メタデータはファイルIDとファイル名などの情報を記録してある
    - ベクトルストアについて
        - 54~55行のコードは空のベクトルストアを作る部分なので、「ストア作成完了。store_name：企業発情報_20251203、ストアID：・・・」という出力があったら、他の部分でエラーが出ていてもベクトルストアは作成済み。
        - 1つのストアにはPDFをいくつも登録できるので株価変動ランキングの日付ごとに作成している。
            - 2025/12/05のストアには12/05のPDFを登録してある
            - 同じファイルを２回登録したり、別の日付のPDFを登録したりしないように注意
    - 注意書き
        - 必ずPDFが全て登録されているか確認する（出力ファイルを見て確認する）。失敗していたら空のベクトルストア生成からやり直し
            - 自分で調べてストア内のファイルを削除や追加してもOK

## 3. 株価変動記事生成
- 3_article_generation_"手法".pyを使用
    - zeroshotとfewshotの２つがあるので必ず16~17行目で手法を指定
    - 13行目で必ず日付を指定する
        - 今日の日付ではなく、株探の株価変動ランキングの日付
    - python src/3_article_generation_"手法".pyで実行
- 入力ファイル
    - data/"日付".csv
    - 24行目で指定、2のPDF登録と同じファイル
    - ベクトルストアID・・・108行目で指定
        - 必ず変更する、2のPDF登録で作られたIDを使用する
        - 別の日付のIDを絶対に使わないこと
- 出力ファイル
    - out/"日付"/article_gen/
    - 入力ファイルに生成記事を追加しただけのcsvファイル
- コード概要
    - baselineとtwostepでコードを分けているので使い分ける
    - fewshotを使う場合はif文などで分岐させるのがよいかも
    - やっているのはただAPIでLLMを呼び出しているだけ

## 4. ROUGEスコア特定
- 4_rouge.pyを使用
    - 14行目で日付を指定
    - 21~24行目で手法を指定する
- 入力ファイル
    - 27行目でファイルを指定（3で作成したcsvファイル）
    - out/"日付"/article_gen/...
        - ここは手動で使いたいファイルの名前を書く必要がある
- 出力ファイル
    - out/rouge_score/
    - 銘柄、コード、スコア（６種類）の情報が入ったcsvファイル

## おまけ　fewshot例の生成コード
- 例示を変えたい場合はsrc/9999_make_prompt.pyを使う

## 補足と注意書き
- 全体的にcsvを一から作成するときに、ファイル名を指示通りにしていれば日付変更するだけ
    - step3はストアIDを指定
    - step4はファイル名を直接指定する手順や、手法を指定する手順がある
- 日付というのは実行した日付ではなく、株価変動ランキングの日付であることに注意
- ストアIDが混在しないように注意
    - 必ず日付ごとに管理する
